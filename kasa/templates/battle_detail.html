{% extends "base.html" %}
{% load static %}
{% block title %}Savaş #{{ battle.id }} Detayları - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    /* Envanter Grid Stilleri */
    .inventory-grid .card { cursor: pointer; border: 2px solid transparent; transition: border-color .2s ease-in-out, transform .2s ease-in-out; position: relative; }
    .inventory-grid .card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, .2); }
    .inventory-grid .card.selected { border-color: #0dcaf0; box-shadow: 0 0 10px rgba(13, 202, 240, .5); }
    .inventory-grid .card label { cursor: pointer; }
    .inventory-grid .rarity-indicator { height: 4px; width: 100%; display: block; position: absolute; top: 0; left: 0; border-top-left-radius: var(--bs-card-inner-border-radius); border-top-right-radius: var(--bs-card-inner-border-radius); }

    /* Sonuç Kartları Stilleri */
    .participant-result-card { margin-bottom: 1rem; }
    .participant-result-card .card-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; padding: 0.5rem 1rem; }
    .participant-result-card .card-body { background-color: #212529; padding: 0.5rem; }
    .participant-result-card.winner-card .card-header { background-color: rgba(25, 135, 84, 0.3); border-left: 5px solid #198754; }
    .participant-result-card.bot-card .card-header { font-style: italic; color: #adb5bd; }
    .unboxed-item-grid { display: flex; flex-wrap: wrap; gap: 3px; }
    .unboxed-item-display { width: 55px; background-color: rgba(0,0,0,0.3); border-radius: 4px; padding: 2px; position: relative; border: 1px solid #444; box-sizing: border-box; }
    .unboxed-item-display .rarity-indicator { height: 3px; position: absolute; top: 0; left: 0; width: 100%; border-top-left-radius: 4px; border-top-right-radius: 4px; }
    .unboxed-item-display img { display: block; width: 100%; height: 35px; object-fit: contain; margin-top: 3px; }

    /* Kasa Savaşı Reel Animasyon Stilleri */
    #battle-animation-area { display: none; /* Başlangıçta gizli */ border: 1px solid #444; background-color: #1a1a1a; padding: 20px; margin-top: 0; margin-bottom: 20px; border-radius: 5px; }
    .participant-reel-container { margin-bottom: 15px; }
    .participant-reel-container:last-child { margin-bottom: 0; }
    .participant-reel-container h6 { margin-bottom: 5px; color: #ffc107; font-size: 0.9rem; }
    .skin-reel-viewport { width: 100%; height: 100px; overflow: hidden; margin: 0 auto; border: 1px solid #444; background-color: #212529; position: relative; border-radius: 5px; box-shadow: inset 0 0 5px rgba(0,0,0,0.4); }
    .reel-marker { width: 3px; background-color: #dc3545; box-shadow: 0 0 8px #dc3545; position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 100%; z-index: 3;}
    .skin-reel { height: 100%; display: flex; align-items: center; transform: translateX(0); }
    .reel-item { width: 80px; height: 80px; flex-shrink: 0; margin: 0 4px; background-color: rgba(255, 255, 255, 0.05); border-radius: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 3px; position: relative; border: 1px solid #444; box-sizing: border-box; }
    .reel-item img { max-height: 65%; max-width: 90%; object-fit: contain; }
    .reel-item .item-name { font-size: 0.6rem; color: #ccc; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 95%; text-align: center; }
    .reel-item::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: var(--rarity-color, #FFFFFF); border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; }
    .reel-item.winner-reel-item { box-shadow: 0 0 10px var(--rarity-color, #FFFFFF); border-color: var(--rarity-color, #FFFFFF); transition: box-shadow 0.3s ease, border-color 0.3s ease; }

    /* Sonuç alanı başlangıçta gizli */
    #battle-results-area { display: none; }
</style>
{% endblock %}


{% block content %}
<h1>Savaş Detayları <span class="badge bg-secondary">#{{ battle.id }}</span></h1>
<hr>
<div class="row">
    {# --- SOL SÜTUN --- #}
    <div class="col-md-8">
        {# --- SAVAŞ ANA ALANI --- #}
        <div class="border rounded p-4 text-center bg-dark-subtle mb-4" style="min-height: 300px;" id="battle-main-area">

            {# 1. Animasyon Alanı (Başlangıçta gizli) #}
            <div id="battle-animation-area">
                <h4 class="text-warning mb-3" id="battle-animation-status">Açılışlar...</h4>
                <div class="row g-3 justify-content-center">
                    {# Katılımcı Reelleri buraya JS ile eklenecek #}
                </div>
            </div>

            {# 2. Sonuç Alanı (Başlangıçta gizli) #}
            <div id="battle-results-area">
                 <h3 class="text-success">Savaş Tamamlandı!</h3>
                 <p class="mb-1">Toplam Açılan Değer: {{ battle.total_value|stringformat:".2f" }} ₺</p>
                 {# Kazanan / Değer Dağılımı Başlığı #}
                 {% if battle.mode == battle.BattleMode.SHARED %}
                      <h5 class="mt-3">Değer Dağılımı:</h5>
                      {% if value_per_participant is not None %} <p class="text-info">Her gerçek katılımcı ~{{ value_per_participant|floatformat:2 }}₺ bakiye kazandı.</p> {# Bakiye olarak güncellendi #}
                      {% else %} <p class="text-muted">Paylaşılacak gerçek katılımcı yok.</p> {% endif %}
                 {% else %}
                     <h5 class="mt-3">Kazanan{% if multiple_winners %}lar{% endif %}:
                         {% for winner_p in winners %} <span class="badge bg-success fs-6 mx-1">{{ winner_p.get_display_name }}</span>
                         {% empty %} <span class="text-muted">Yok / Belirlenemedi</span> {% endfor %}
                     </h5>
                 {% endif %}
                 <hr class="my-3">
                 {# Açılan Eşyalar (Kart Görünümü) #}
                 <h6>Açılan Eşyalar:</h6>
                 <div class="row g-3">
                     {% for p in battle.participants.all %}
                        <div class="col-lg-6 mb-3">
                             <div class="card participant-result-card h-100 {% if p.is_winner and battle.mode != battle.BattleMode.SHARED %}winner-card{% endif %} {% if p.is_bot %}bot-card{% endif %}">
                                 <div class="card-header">
                                     <span>{{ p.get_display_name }}</span>
                                     <span class="badge {% if p.is_winner and battle.mode != battle.BattleMode.SHARED %}bg-warning text-dark{% elif battle.mode == battle.BattleMode.SHARED and not p.is_bot %}bg-info text-dark{% else %}bg-light text-dark{% endif %}">
                                         {{ p.total_unboxed_value|stringformat:".2f" }} ₺
                                     </span>
                                 </div>
                                 <div class="card-body">
                                     {# Gizli veri deposu (JS için) #}
                                     <div class="d-none unboxing-data-storage" data-participant-id="{{ p.id }}" data-participant-name="{{ p.get_display_name }}" data-is-bot="{{ p.is_bot|yesno:'true,false' }}">
                                          {% for unboxing in p.unboxings.all %} <span class="unboxing-item" data-skin-id="{{ unboxing.unboxed_skin.id }}" data-skin-name="{{ unboxing.unboxed_skin.name }}" data-skin-image="{{ unboxing.unboxed_skin.image_url|default:'#' }}" data-skin-rarity="{{ unboxing.unboxed_skin.rarity.color_hex|default:'#FFFFFF' }}" data-skin-value="{{ unboxing.unboxed_skin.value }}"></span> {% endfor %}
                                     </div>
                                     {# Görsel itemler #}
                                     <div class="unboxed-item-grid">
                                         {% for unboxing in p.unboxings.all %}
                                             <div class="unboxed-item-display" title="{{ unboxing.unboxed_skin.name }} ({{ unboxing.unboxed_skin.value|stringformat:'.2f' }}₺)">
                                                  <div class="rarity-indicator" style="background-color: {{ unboxing.unboxed_skin.rarity.color_hex|default:'#FFFFFF' }};"></div>
                                                 <img src="{{ unboxing.unboxed_skin.image_url|default:'#' }}" alt="{{ unboxing.unboxed_skin.name }}">
                                             </div>
                                         {% empty %} <p class="text-muted small w-100 m-0">Eşya açılmadı.</p>
                                         {% endfor %}
                                     </div>
                                 </div>
                             </div>
                        </div>
                     {% empty %} <p class="text-muted">Katılımcı yok.</p>
                     {% endfor %}
                 </div>
                 {# Tekrar İzleme Butonu (Artık Gerekli Değil?) - Yorumda kalsın #}
                 {# <button id="replay-battle-button" class="btn btn-sm btn-outline-info mt-4">Açılışları Tekrar İzle</button> #}
            </div>

            {# 3. Diğer Durumlar (WAITING, STARTING, CANCELLED, ERROR) #}
            <div id="battle-status-display" style="display: none;"> {# Başlangıçta JS kontrolü için gizli #}
                 {% if battle.status == battle.BattleStatus.WAITING %}
                    <h3 class="text-muted">Katılımcılar Bekleniyor...</h3>
                    <p>Savaşın başlaması için {{ battle.max_participants }} katılımcıya ulaşılması gerekiyor.</p>
                    <div class="spinner-border text-warning" role="status"> <span class="visually-hidden">Bekleniyor...</span> </div>
                 {% elif battle.status == battle.BattleStatus.STARTING %}
                     <h3 class="text-warning">Savaş Başladı!</h3>
                     <p>Kasalar açılıyor...</p>
                     <div class="spinner-grow text-warning" role="status"> <span class="visually-hidden">Açılıyor...</span> </div>
                     <p class="mt-3 text-muted small">(Animasyon gösterilecek...)</p>
                {% elif battle.status == battle.BattleStatus.CANCELLED %} <h3 class="text-danger">Savaş İptal Edildi</h3>
                {% elif battle.status == battle.BattleStatus.ERROR %} <h3 class="text-danger">Savaş Sırasında Hata Oluştu</h3> <p class="text-muted small">Yönetici ile iletişime geçin.</p>
                {% endif %}
            </div>

        </div>
        {# --- ANA ALAN SONU --- #}

        {# Savaştaki Kasalar #}
        <h4>Savaştaki Kasalar:</h4>
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2 mb-4">
             {% for case in battle.cases.all %} <div class="col"> <div class="card card-sm text-center bg-secondary"> <img src="{{ case.image_url|default:'#' }}" class="card-img-top p-1" alt="{{ case.name }}" style="max-height: 50px; object-fit: contain;"> <div class="card-body p-1"> <small class="card-title text-white text-truncate d-block" style="font-size: 0.7rem;">{{ case.name }}</small> <small class="text-white-50 d-block">{{case.price}}₺</small> </div> </div> </div> {% empty %} <p class="text-muted">Kasalar yüklenemedi.</p> {% endfor %}
        </div>
    </div>

    {# --- Sağ Sütun (Aynı) --- #}
    <div class="col-md-4">
        {# ... (Sağ sütun içeriği öncekiyle aynı) ... #}
         <h4>Savaş Bilgileri</h4>
        <ul class="list-group mb-3">
             <li class="list-group-item d-flex justify-content-between align-items-center">Durum: <span class="badge {% if battle.status == battle.BattleStatus.WAITING %}bg-info{% elif battle.status == battle.BattleStatus.STARTING %}bg-warning text-dark{% elif battle.status == battle.BattleStatus.FINISHED %}bg-success{% elif battle.status == battle.BattleStatus.CANCELLED or battle.status == battle.BattleStatus.ERROR %}bg-danger{% else %}bg-secondary{% endif %}">{{ battle.get_status_display }}</span></li>
             <li class="list-group-item d-flex justify-content-between align-items-center">Mod: <span>{{ battle.get_mode_display }}</span></li>
             <li class="list-group-item d-flex justify-content-between align-items-center">Maliyet: <span>{{ battle.get_total_cost|stringformat:".2f" }} ₺</span></li>
             <li class="list-group-item d-flex justify-content-between align-items-center">Oluşturan: <span>{{ battle.creator.user.username|default:"N/A" }}</span></li>
             <li class="list-group-item d-flex justify-content-between align-items-center">Oluşturulma: <span>{{ battle.created_at|date:"d.m.Y H:i" }}</span></li>
             {% if battle.started_at %} <li class="list-group-item d-flex justify-content-between align-items-center">Başlama: <span>{{ battle.started_at|date:"d.m.Y H:i" }}</span></li> {% endif %}
             {% if battle.finished_at %} <li class="list-group-item d-flex justify-content-between align-items-center">Bitiş: <span>{{ battle.finished_at|date:"d.m.Y H:i" }}</span></li> {% endif %}
        </ul>
         <h4>Katılımcılar (<span id="participant-count">{{ battle.get_participant_count }}</span>/{{ battle.max_participants }})</h4>
         <ul class="list-group mb-3" id="participant-list">
             {% for p in battle.participants.all %}
                <li class="list-group-item {% if p.is_winner and battle.mode != battle.BattleMode.SHARED %}list-group-item-success{% endif %} {% if p.is_bot %}text-muted fst-italic{% endif %}">
                    {{ p.get_display_name }}
                    {% if battle.status == battle.BattleStatus.FINISHED and not p.is_bot %} <small class="text-muted float-end">({{ p.total_unboxed_value|stringformat:".2f" }}₺)</small> {% endif %}
                 </li>
             {% empty %} <li class="list-group-item text-muted">Henüz katılımcı yok.</li> {% endfor %}
         </ul>
        {% if user.is_authenticated %}
            {% if can_add_bot %} <button id="add-bot-button" class="btn btn-sm btn-outline-secondary w-100 mb-2">Bot Ekle</button> <div id="add-bot-status" class="small text-muted text-center mb-2"></div> {% endif %}
            {% if can_join %} <form method="post" action=""> {% csrf_token %} <button type="submit" class="btn btn-success w-100" disabled> {{ battle.get_total_cost|stringformat:".2f" }} ₺ ile Savaşa Katıl (Pasif)</button> </form>
            {% elif is_participant and battle.status == battle.BattleStatus.WAITING %} <p class="text-success">Bu savaşa zaten katıldın.</p>
            {% elif not is_participant and battle.status != battle.BattleStatus.WAITING and battle.status != battle.BattleStatus.STARTING %} <p class="text-muted">Bu savaş artık katılım için uygun değil.</p> {% endif %}
        {% else %} <a href="{% url 'account_login' %}" class="btn btn-primary w-100">Savaşa Katılmak İçin Giriş Yap</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Element Referansları ---
    const addBotButton = document.getElementById('add-bot-button');
    const addBotStatus = document.getElementById('add-bot-status');
    const participantList = document.getElementById('participant-list');
    const participantCountSpan = document.getElementById('participant-count');
    // const replayButton = document.getElementById('replay-battle-button'); // Kaldırıldı
    const battleAnimationArea = document.getElementById('battle-animation-area');
    const battleResultsArea = document.getElementById('battle-results-area');
    const battleAnimationStatus = document.getElementById('battle-animation-status');
    const battleStatusDisplay = document.getElementById('battle-status-display');

    // --- Diğer Değişkenler ---
    const battleId = {{ battle.id }};
    const addBotUrl = "{% url 'add_bot_to_battle_ajax' battle.id %}";
    const getResultsUrl = "{% url 'get_battle_results_ajax' battle.id %}";
    const finalizeUrl = "{% url 'finalize_battle_ajax' battle.id %}"; // Sonlandırma URL'i
    const csrfTokenBattle = "{{ csrf_token }}";
    let currentBattleStatus = "{{ battle.status }}";
    const colLgClassValue = {{ col_lg_class_value|default:6 }};
    let isAnimating = false;

    // --- Yardımcı Fonksiyonlar ---
    function resetInitialState() {
        if(battleAnimationArea) battleAnimationArea.style.display = 'none';
        if(battleResultsArea) battleResultsArea.style.display = 'none';
        if(battleStatusDisplay) battleStatusDisplay.style.display = 'block';

        const resultsShouldBeVisible = currentBattleStatus === 'FINISHED'; // JS status'unu kullan
        if(battleResultsArea) battleResultsArea.style.display = resultsShouldBeVisible ? 'block' : 'none';
        // Replay butonu kaldırıldı
        if(battleStatusDisplay) battleStatusDisplay.style.display = !resultsShouldBeVisible ? 'block' : 'none';

        const canAddBot = {{ can_add_bot|yesno:"true,false" }} && currentBattleStatus === 'WAITING'; // Durumu da kontrol et
        if (addBotButton) { addBotButton.disabled = !canAddBot; addBotButton.style.display = canAddBot ? 'block' : 'none';}
        isAnimating = false;
    }

    // --- Kasa Açma Reel Animasyon Fonksiyonu ---
    function runSingleReelAnimation(reelContainerElement, reelItems, winnerItem) {
        // ... (İçerik aynı) ...
        return new Promise((resolve) => { /* ... önceki reel animasyon kodu ... */ resolve();});
    }

    // --- SAVAŞ SONUÇLARINI ALIP ANİMASYONU BAŞLATAN FONKSİYON ---
    function fetchBattleResultsAndAnimate() {
         if (isAnimating || !battleAnimationArea || !battleResultsArea || !battleStatusDisplay) { console.warn("Animasyon başlatılamadı."); resetInitialState(); return; }
         isAnimating = true;
         console.log("Savaş sonuçları getiriliyor ve animasyon başlatılıyor...");
         if(battleStatusDisplay) battleStatusDisplay.style.display = 'none'; battleResultsArea.style.display = 'none'; battleAnimationArea.style.display = 'block';
         const animAreaContent = battleAnimationArea.querySelector('.row.g-3');
         if (animAreaContent) { animAreaContent.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-light"></div></div>'; }
         if(battleAnimationStatus) battleAnimationStatus.textContent = "Kasalar Açılıyor...";

        fetch(getResultsUrl) // Önce sonuçları al
            .then(response => response.json())
            .then(data => {
                if (data.success && data.participants) {
                    console.log("Sonuçlar alındı, animasyonlar başlıyor.");
                     if(animAreaContent) animAreaContent.innerHTML = '';
                     if(battleAnimationStatus) battleAnimationStatus.textContent = "Açılışlar...";

                    const animationPromises = data.participants.map(p => {
                        // ... (Her katılımcı için reel oluşturma - önceki gibi) ...
                        const container = document.createElement('div'); container.className = `participant-reel-container col-md-6 col-lg-${colLgClassValue}`; /*...*/ container.appendChild(viewport); if(animAreaContent) animAreaContent.appendChild(container);
                        // ... (winnerSkin bulma) ...
                        // ... (reelItems oluşturma) ...
                        return runSingleReelAnimation(viewport, p.unboxings, winnerSkin); // Pass actual unboxings
                    });

                    // Tüm animasyonlar bitince savaşı sonlandır
                    Promise.all(animationPromises).then(() => {
                         console.log("Tüm savaş animasyonları bitti. Sonlandırma isteği gönderiliyor...");
                         if(battleAnimationStatus) battleAnimationStatus.textContent = "Savaş Sonlandırılıyor...";

                         // --- Savaşı Sonlandırma İsteği ---
                         fetch(finalizeUrl, {
                             method: 'POST', // <<< EKSİK OLAN METHOD BURAYA EKLENDİ
                             headers: { 'X-CSRFToken': csrfTokenBattle, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                             // Body göndermeye gerek yok, sadece isteği yapmak yeterli
                         })
                         .then(response => response.json())
                         .then(finalizeData => {
                             if (finalizeData.success) {
                                  console.log("Savaş başarıyla sonlandırıldı.");
                                  currentBattleStatus = 'FINISHED'; // JS durumunu güncelle
                                  // Sonuçları DOM'da güncellemek yerine resetInitialState çağırabiliriz
                                  resetInitialState(); // Animasyon gizlenir, sonuçlar görünür
                             } else { /* Finalize hatası */ console.error("Savaş sonlandırma hatası:", finalizeData.error); if(battleAnimationStatus) battleAnimationStatus.textContent = `Hata: ${finalizeData.error}`; setTimeout(resetInitialState, 3000); }
                         })
                         .catch(error => { /* Finalize fetch hatası */ console.error("Savaş sonlandırma fetch hatası:", error); if(battleAnimationStatus) battleAnimationStatus.textContent = 'Sonlandırma hatası!'; setTimeout(resetInitialState, 3000); });
                         // --- Sonlandırma İsteği Sonu ---

                    }); // Promise.all sonu

                } else { /* Sonuç alınamadı hatası */ console.error("Savaş sonuçları alınamadı:", data.error); if(battleAnimationArea) battleAnimationArea.innerHTML = `<p>Hata.</p>`; setTimeout(resetInitialState, 2000); }
            })
            .catch(error => { /* Fetch hatası */ console.error('Savaş sonuçları fetch hatası:', error); if(battleAnimationArea) battleAnimationArea.innerHTML = `<p>Hata.</p>`; setTimeout(resetInitialState, 2000); });
    } // fetchBattleResultsAndAnimate sonu

    // --- Bot Ekleme Mantığı ---
    if (addBotButton) {
        addBotButton.addEventListener('click', () => {
             if (isAnimating) return;
             addBotButton.disabled = true; addBotStatus.textContent = 'Bot ekleniyor...'; /* ... */
            fetch(addBotUrl, { method: 'POST', headers: { 'X-CSRFToken': csrfTokenBattle, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, })
            .then(response => response.json()).then(data => {
                if (data.success) {
                    addBotStatus.textContent = data.message; addBotStatus.className = 'small text-success text-center mb-2';
                    if(participantCountSpan) participantCountSpan.textContent = data.participant_count;
                    /* ... (liste güncelleme) ... */
                     const newBotLi = document.createElement('li'); newBotLi.className = 'list-group-item text-muted fst-italic'; newBotLi.textContent = `Bot ${data.participant_count}`; if(participantList){ const noP = participantList.querySelector('.list-group-item.text-muted'); if(noP && participantList.children.length === 1 && noP.textContent.includes('yok')){noP.remove();} participantList.appendChild(newBotLi); }

                    if(data.is_full){
                        if(addBotButton) addBotButton.style.display = 'none';
                        currentBattleStatus = data.battle_status; // JS durumunu güncelle
                        addBotStatus.textContent = 'Savaş Doldu! Başlatılıyor...';
                        addBotStatus.className = 'small text-warning text-center mb-2';
                        if (currentBattleStatus === 'STARTING') { // Backend STARTING döndürdüyse
                             console.log("Savaş başladı, sonuçlar alınıp animasyon başlatılacak...");
                             fetchBattleResultsAndAnimate(); // <<< Animasyonu tetikle
                        } else { console.error("Savaş doldu ama durum STARTING değil:", currentBattleStatus); addBotStatus.textContent = 'Hata: Savaş durumu!'; addBotStatus.className = 'small text-danger text-center mb-2'; }
                    } else { addBotButton.disabled = false; }
                } else { /* ... (hata durumu) ... */ addBotStatus.textContent = 'Hata: '+data.error; addBotStatus.className = 'small text-danger text-center mb-2'; addBotButton.disabled = false;}
            }).catch(error => { /* ... (fetch hatası) ... */ console.error('Bot ekleme fetch hatası:', error); addBotStatus.textContent = 'Sunucu hatası.'; addBotStatus.className = 'small text-danger text-center mb-2'; addBotButton.disabled = false; });
        });
    }

    // --- Sayfa Yüklendiğinde Başlangıç Durumu ---
    resetInitialState(); // Başlangıç görünümünü ayarla

}); // DOMContentLoaded sonu
</script>
{% endblock %}